<!DOCTYPE html>
<html>
    <head>

    </head>

    <style>
        *{
            background-color: black;
            color: white;
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
        }

        #Tile{
            text-align: left;
            border: 3px solid;
            border-radius: 36px;
            border-color: white;
            color: r;
            width: 75%;
            margin: auto;
            padding: 20px;
        }

        #Tile #skyBody{
            width: 50px;
            height: 50px;
            margin: auto;
            border-radius: 50%;
            padding-left: 3%;
        }

        .sun{
            background-color: yellow;
            border: 0.2cm;
            border-style: groove;
            border-color: lightblue;
        }

        .moon{
            background-color: grey;
            border: 0.2cm;
            border-style: groove;
            border-color: darkblue;
        }

        .day{
            background-color: lightblue;
            border: 3px solid;
            border-color: white;
            border-radius: 12px;
        }

        .day h3{
            background-color: lightblue;
            color: black;
            text-align: start;
        }
        
        .night{
            background-color: rgb(0, 0, 90);
            border: 3px solid;
            border-color: white;
            border-radius: 12px;
        }

        .night h3{
            background-color: rgb(0, 0, 90);
            color: white;
            text-align: start;
        }

        #Tile h3{
            text-align: start;
            padding-left: 5%;
        }

        #Time{
            text-align: center;
            margin: auto;
        }

        .TimeBox{
            border: 3px solid;
            border-color: white;
            border-radius: 6px;
            padding: 20px;
        }
        
    </style>

    <body>
        <h1>Useless Weather</h1>
        <div id="WeatherInfo">

        </div>

        <!--
            Info Card

        <div id="Tile" ${timeTileDisplay}>
            <div style="display: flex;" ${timeTileDisplay}>
                <div class = "TimeBox">
                    <h1 id = "Time">[${hour}:${minute}]</h1>
                    <h6 id = "Time">(Time recorded)</h6>
                </div>
                <button ${timeDisplayBody} class="moon" id="skyBody"></button>
            </div>
            <h3>Temperature     : ${weatherInfo.current.temperature_2m}째C</h3>
            <h3>Feeling like ${weatherInfo.current.apparent_temperature}째C</h3>
            <h3>Humidity        : ${weatherInfo.current.relative_humidity_2m}%</h3>
            <h3>Rain            : ${weatherInfo.current.rain} mm</h3>
            <h3>Wind Speed      : ${weatherInfo.current.wind_speed_10m}km/hr</h3>
            <h3>Wind Direction  : ${windDirection}</h3>
            <h3>Location        : ${areaCounty} ${areaRegion} ${areaState} ${locationData.address.country}</h3>
        </div>
        -->

        <button onclick="fetchInfo()" style="font-size: 35px; width: 250px; height: 125px; font-family: Arial, Helvetica, sans-serif; background-color: black; color: white;">Refresh Data</button>
        
    </body>

    <script>
        function displayInfo(weatherInfo,locationData,countryData){

            //Time
            let timestamp = weatherInfo.current.time;
            var date = new Date(timestamp * 1000);
            var hour = date.getHours();
            var minute = date.getMinutes();

            if(hour < 10){
                hour = "0" + hour;
            }
            if(minute < 10){
                minute = "0" + minute;
            }

            let timeDisplayBody = ``;
            let timeTileDisplay = ``;
            if(weatherInfo.current.is_day == 1){
                timeDisplayBody = `class = "sun"`;
                timeTileDisplay = `class = "day"`;
            }
            else{
                timeDisplayBody = `class = "moon"`;
                timeTileDisplay = `class = "night"`;
            }

            //WindIDrection
            let windDirectionData = weatherInfo.current.wind_direction_10m;
            let windDirection = ``;

            if(windDirectionData > -1 && windDirectionData < 23){
                windDirection = "N";
            }
            if(windDirectionData > 22 && windDirectionData < 68){
                windDirection = "NE";
            }
            if(windDirectionData > 67 && windDirectionData < 113){
                windDirection = "E";
            }
            if(windDirectionData > 112 && windDirectionData < 158){
                windDirection = "SE";
            }
            if(windDirectionData > 157 && windDirectionData < 203){
                windDirection = "S";
            }
            if(windDirectionData > 202 && windDirectionData < 248){
                windDirection = "SW";
            }
            if(windDirectionData > 247 && windDirectionData < 293){
                windDirection = "W";
            }
            if(windDirectionData > 292 && windDirectionData < 338){
                windDirection = "NW";
            }
            if(windDirectionData > 337 && windDirectionData < 360){
                windDirection = "N";
            }

            console.log(windDirection);
            
            //Location
            if(locationData.error == "Unable to geocode"){
                fetchInfo();
            }
            
            let areaState = locationData.address.state + ",";
            let areaRegion = locationData.address.region + ",";
            let areaCounty = locationData.address.county + ",";
            
            if(locationData.address.state == null){
                areaState = "";
            }
            if(locationData.address.region == null){
                areaRegion = "";
            }
            if(locationData.address.county == null){
                areaCounty = "";
            }

            //console.log(locationData.address.region);
            //console.log(locationData.address.state);
            //console.log(locationData.address.state_district);
            //console.log(locationData.address.county);
            //console.log(locationData.address.country_code);
            
            //Display
            let display = document.querySelector(`#WeatherInfo`);
            let displayInfoTile = ``;

            displayInfoTile += `
            <div id="Tile">
                <div style="display: flex;" ${timeTileDisplay}>
                    <div class = "TimeBox">
                        <h1 id = "Time">[${hour}:${minute}]</h1>
                        <h6 id = "Time">(Time recorded)</h6>
                    </div>
                    <button ${timeDisplayBody} id="skyBody"></button>
                </div>
                <h3>Temperature     : ${weatherInfo.current.temperature_2m}째C</h3>
                <h3>Feeling like ${weatherInfo.current.apparent_temperature}째C</h3>
                <h3>Humidity        : ${weatherInfo.current.relative_humidity_2m}%</h3>
                <h3>Rain            : ${weatherInfo.current.rain} mm</h3>
                <h3>Wind Speed      : ${weatherInfo.current.wind_speed_10m}km/hr</h3>
                <h3>Wind Direction  : ${windDirection}</h3>
                <h3>Location        : ${areaCounty} ${areaRegion} ${areaState} ${locationData.address.country}</h3>
            </div>`;

            display.innerHTML = displayInfoTile;
        }

        function setNumbers(){
            let latitude = Math.random() * (90 - 0) + 0;
            let latInv = Math.floor(Math.random() * 2);
            let longitude = Math.random() * (180 - 0) + 0;
            let lonInv = Math.floor(Math.random() * 2);

            if(latInv === 1){
                latitude = latitude * -1.00;
            }
            if(lonInv === 1){
                longitude = longitude * -1.00;
            }
            
            return [latitude,longitude];
        }

        async function fetchInfo(){
            let latitude = 0;
            let longitude = 0;
            
            //T&T data for testing
            //let coordinate = [10.163188022378257,-61.440930127254724];

            let coordinate = setNumbers();

            console.log(coordinate);

            //let currentPosition = navigator.geolocation.getCurrentPosition();

            //console.log(currentPosition);
            //setNumbers(latitude,longitude);
            //10.163188022378257, -61.440930127254724

            var locationResponce = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${coordinate[0]}&lon=${coordinate[1]}&format=json`);
            var locationData = await locationResponce.json();
            var weatherResponce = null;
            var weatherData = null;
            var countryResponce = null;
            var countryData = null;
            if(locationData.error!=null){
                console.log("No");
                fetchInfo();
            }
            else{
                console.log("Yes");
                weatherResponce = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coordinate[0]}&longitude=${coordinate[1]}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,wind_speed_10m,wind_direction_10m&timeformat=unixtime&timezone=auto&forecast_days=1`);
                weatherData = await weatherResponce.json();
                //countryResponce = await fetch(`https://restcountries.com/v3.1/all`);
                //countryData = countryResponce.json();
            }

            displayInfo(weatherData,locationData,countryData);
        }

        //setNumbers();
        fetchInfo();
    </script>
</html>